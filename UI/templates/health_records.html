<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>My Health Records</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

  <style>
    body {
      background: #f4f7ff;
      font-family: "Segoe UI", sans-serif;
    }

    .records-header {
      background: linear-gradient(135deg, #487cff, #6b9dff);
      padding: 35px 20px;
      border-radius: 0 0 18px 18px;
      box-shadow: 0 4px 14px rgba(0, 0, 0, 0.2);
      color: white;
    }

    .records-card {
      background: #ffffff;
      padding: 25px;
      border-radius: 18px;
      margin-top: -25px;
      box-shadow: 0px 4px 20px rgba(0, 0, 0, 0.12);
    }

    table {
      border-radius: 10px;
      overflow: hidden;
    }

    thead {
      background: #5186ff;
      color: white;
      font-weight: 600;
    }

    tbody tr:hover {
      background: #eef3ff;
      transition: 0.2s;
    }

    .empty-box {
      padding: 40px;
      text-align: center;
      color: #6b6b6b;
    }

    .tag-skin {
      background: #ffe1e1;
      color: #d12a2a;
      padding: 4px 10px;
      border-radius: 10px;
    }

    .tag-xray {
      background: #e3eaff;
      color: #2a4bd1;
      padding: 4px 10px;
      border-radius: 10px;
    }
  </style>
</head>

<body>

  <div class="records-header text-center">
    <h1>My Health Records</h1>
    <p>Your saved predictions</p>
  </div>

  <div class="container">
    <div class="records-card">

      <div class="d-flex justify-content-end mb-3">
        <button id="refreshRecords" class="btn btn-primary">Refresh</button>
      </div>

      <div class="table-responsive">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>Date</th>
              <th>Type</th>
              <th>Label</th>
              <th>Confidence</th>
              <th>File Name</th>
              <th>Delete</th>
            </tr>
          </thead>

          <tbody id="recordsBody">
            <tr>
              <td colspan="6">
                <div class="empty-box">Loading...</div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

    </div>
  </div>

  <!-- FIREBASE LOGIC -->
  <script type="module">
    import { auth, db } from "/static/firebase-init.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";
    import {
      collection,
      query,
      orderBy,
      getDocs,
      deleteDoc,
      doc
    } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

    const recordsBody = document.getElementById("recordsBody");
    const refreshBtn = document.getElementById("refreshRecords");

    function renderEmpty(msg) {
      recordsBody.innerHTML =
        `<tr><td colspan="6"><div class='empty-box'>${msg}</div></td></tr>`;
    }

    function formatDate(ts) {
      try {
        return ts?.toDate ? ts.toDate().toLocaleString() : new Date(ts).toLocaleString();
      } catch {
        return "-";
      }
    }

    async function fetchAndRender(uid) {
      if (!uid) return renderEmpty("Please login to view records.");

      try {
        const q = query(collection(db, "users", uid, "predictions"), orderBy("createdAt", "desc"));
        const snap = await getDocs(q);

        if (snap.empty) return renderEmpty("No records found.");

        const rows = [];
        snap.forEach(d => rows.push({ id: d.id, ...d.data() }));

        const html = rows.map(r => {
          const conf = r.confidence ? (r.confidence * 100).toFixed(2) + "%" : "N/A";

          return `
            <tr>
              <td>${formatDate(r.createdAt)}</td>
              <td>${r.type === "skin" ? "<span class='tag-skin'>Skin</span>" : "<span class='tag-xray'>X-ray</span>"}</td>
              <td><strong>${r.label || "-"}</strong></td>
              <td>${conf}</td>
              <td>${r.filename || "-"}</td>
              <td>
                <button class="btn btn-danger btn-sm" onclick="deleteRecord('${r.id}')">
                  Delete
                </button>
              </td>
            </tr>`;
        }).join("");

        recordsBody.innerHTML = html;

      } catch (err) {
        console.error(err);
        renderEmpty("Error loading records.");
      }
    }

    // DELETE RECORD FUNCTION
    window.deleteRecord = async function (id) {
      if (!confirm("Delete this record permanently?")) return;

      try {
        const user = auth.currentUser;
        await deleteDoc(doc(db, "users", user.uid, "predictions", id));
        fetchAndRender(user.uid);
      } catch (err) {
        console.error(err);
        alert("Failed to delete record");
      }
    };

    refreshBtn.addEventListener("click", () => {
      const user = auth.currentUser;
      fetchAndRender(user?.uid);
    });

    onAuthStateChanged(auth, (user) => {
      if (!user) return window.location.href = "/login.html";
      fetchAndRender(user.uid);
    });

  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>
